<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="Minkeun Park">
        <link rel="canonical" href="https://mkparkqq.github.io/cprogramming/memory-layout/">
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>C program memory layout - freema</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/fontawesome.min.css" rel="stylesheet">
        <link href="../../css/brands.min.css" rel="stylesheet">
        <link href="../../css/solid.min.css" rel="stylesheet">
        <link href="../../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" >
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" disabled>
        <link href="../../estyle.css" rel="stylesheet">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">freema</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar-collapse" aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">UNIX</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../unix/process-relationships/" class="dropdown-item">세션</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">MariaDB</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../mariadb/test-framework/" class="dropdown-item">테스트 프레임워크</a>
</li>
                                    
<li>
    <a href="../../mariadb/tap-api/" class="dropdown-item">MyTAP</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle active" aria-current="page" role="button" data-bs-toggle="dropdown"  aria-expanded="false">C/C++</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../zombie-process/" class="dropdown-item">zombie process</a>
</li>
                                    
<li>
    <a href="../how-to-use-openssl-pkcs-api/" class="dropdown-item">OpenSSL PKCS API</a>
</li>
                                    
<li>
    <a href="../devenv/" class="dropdown-item">개발환경</a>
</li>
                                    
<li>
    <a href="./" class="dropdown-item active" aria-current="page">C program memory layout</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Note</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../note/programming-principle/" class="dropdown-item">프로그래밍 원칙</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">DIY</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../diy/raspberrypi-communication/" class="dropdown-item">Raspberry Pi GPIO</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../devenv/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../../note/programming-principle/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-body-tertiary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-bs-level="1"><a href="#c-program-memory-layout" class="nav-link">C program memory layout</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-bs-level="2"><a href="#logical-diagram" class="nav-link">logical diagram</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#registers" class="nav-link">registers</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#example1" class="nav-link">example1</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#example2" class="nav-link">example2</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#references" class="nav-link">references</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="c-program-memory-layout">C program memory layout</h1>
<p>C 프로그램이 메모리에 로드되는 형태</p>
<hr>

<h2 id="logical-diagram">logical diagram</h2>
<ul>
<li>c 실행파일이 메모리에 로드되는 형태는 아래와 같다</li>
<li>스택 프레임 여러 개를 묶어서 스택이라고 한다</li>
<li>함수가 호출될때마다 스택 프레임 한 개가 생성된다. 스택 프레임은 함수의 실행 환경을 제공한다</li>
</ul>
<p><img src="/img/c-program-memory-layout.png" alt="c-program-memory-layout" width="70%" /></p>
<h2 id="registers">registers</h2>
<ul>
<li>rbp(base pointer) : 현재 스택 프레임의 가장 낮은 주소</li>
</ul>
<h2 id="example1">example1</h2>
<ul>
<li>아래의 명령어로 c code를 assembly code로 컴파일 (x86_64 cpu)</li>
<li><code>gcc -S scratch.c -o scratch.o</code></li>
</ul>
<p><img src="/img/20241110-scratch.c.png" alt="example1-c-code" /></p>
<p><img src="/img/20241110-scratch.s-descripted.png" alt="example1-s-code" /></p>
<ul>
<li>변수의 선언만 한 경우 스택을 할당하지만 초기화까지 하는 경우 immediate value를 레지스터에 저장하는 instruction이 추가된다</li>
</ul>
<h3 id="x86-instructions-registers">x86 instructions &amp; registers</h3>
<ul>
<li><code>$0</code>, <code>$1</code> - immediate value(주소값이 아닌 리터럴)</li>
<li>mov - memory와 processor register 사이의 값 이동(복사). 반드시 operand 하나는 register이다. 나머지 하나는 immediate value일 수도 있고 메모리 주소일 수도 있다.<ul>
<li><code>movq</code> - 64비트 값 이동 (주로 메모리 주소값)</li>
<li><code>movl</code> - 32비트 값 이동</li>
</ul>
</li>
<li><code>lea</code> - load effective address<ul>
<li>주소값을 계산해서 dst에 저장한다 (메모리에서 값을 로드하지 않는다)</li>
<li>lea 80(%rdx,%rcx,2),$rax - $rax=80+%rdx+2*%rcx</li>
</ul>
</li>
<li><code>rip</code> - instruction pointer</li>
<li><code>%rdi</code> <code>%rsi</code> <code>%rdx</code> <code>%rcx</code> <code>%r8</code> <code>%r9</code> - callee function의 argument 저장<ul>
<li><a href="https://en.wikipedia.org/wiki/X86_calling_conventions">x86_64 calling conventions</a> 참고</li>
</ul>
</li>
</ul>
<h3 id="function-prologue">function prologue</h3>
<ul>
<li>함수 실행에 필요한 register, stack을 준비한다</li>
<li>Pushes current base pointer onto the stack, so it can be restored later. <ul>
<li><code>pushq %rbp</code> - %rbp의 값을 %rsp가 가리키는 공간에 저장</li>
</ul>
</li>
<li>Value of base pointer is set to the address of stack pointer (which is pointed to the top of the stack) so that the base pointer will point to the top of the stack. <ul>
<li><code>moveq %rsp, %rbp</code> - %rbp에 %rsp의 값을 저장(새로운 스택의 base 주소(%rbp)를 이전 스택의 가장 높은 주소(%rsp)로 설정)</li>
</ul>
</li>
<li>Moves the stack pointer further by decreasing or increasing its value, depending on whether the stack grows down or up. On x86, the stack pointer is decreased to make room for the function's local variables.<ul>
<li><code>subq $16, %rsp</code> - 지역변수를 저장할 공간을 할당</li>
</ul>
</li>
</ul>
<h3 id="function-epilogue">function epilogue</h3>
<ul>
<li>function prologue의 반대 과정. (Function epilogue reverses the actions of the function prologue and returns control to the calling function.)<ul>
<li>control - cpu에 대한 주도권. 레지스터에 f1함수에 대한 값이 저장되어 있다면 control은 f1에게 있다</li>
</ul>
</li>
<li>Drop the stack pointer to the current base pointer, so room reserved in the prologue for local variables is freed.<ul>
<li><code>leave</code> - <code>mov %rbp, %rsp</code>와 <code>pop %rbp</code> 명령어를 결합한 명령어</li>
</ul>
</li>
<li>Pops the base pointer off the stack, so it is restored to its value before the prologue.</li>
<li>Returns to the calling function, by popping the previous frame's program counter off the stack and jumping to it.</li>
</ul>
<h2 id="example2">example2</h2>
<ul>
<li>초기화하지 않은 변수에 대한 최적화</li>
</ul>
<p><img src="/img/20241110-example2.png" alt="example2" /></p>
<ul>
<li>%eax - return value</li>
<li><code>int b = b;</code> - 의도적으로 초기화하지 않음을 컴파일러에게 알려준다.<ul>
<li>이런 코드 없이 초기화 하지 않으면 컴파일할때 경고 메세지가 출력된다. </li>
<li>그렇다고 <code>int b =0;</code>과 같이 초기화할 경우 <code>movl $0, -16(%rbp)</code> 라는 instruction이 추가된다.</li>
<li>이런 instruction은 프로세서에서 메모리로 값을 복사하기 때문에 없애면 성능이 향상된다</li>
</ul>
</li>
</ul>
<p><img src="/img/20241110-example2-wall.png" alt="warning message" /></p>
<hr>

<h2 id="references">references</h2>
<ul>
<li><a href="https://www.geeksforgeeks.org/memory-layout-of-c-program/">geeksforgeeks.org/memory-layout-of-cprogram</a></li>
<li><a href="https://en.wikipedia.org/wiki/Function_prologue_and_epilogue">function prologue and epilogue</a></li>
<li><a href="https://ee.usc.edu/~redekopp/cs356/slides/CS356Unit4_x86_ISA.pdf">x86 Instruction Set</a></li>
<li><a href="https://en.wikipedia.org/wiki/X86_calling_conventions">x86 calling convention</a></li>
</ul>
<hr id="utteranc-area-division">
<div id="utteranc-area">
    <script src="https://utteranc.es/client.js"
        repo="mkparkqq/qqDocs-comment"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
    </script>
</div></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js"></script>
        <script src="../../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
